#!/bin/sh

pdnsHealthcheckPg(){
	if [ "${PDNS_PSQL_KUBE_INIT_READY:-0}" = 0 ]
	then
		SOURCE_ONLY=1 . pdns-psql
	fi

	local sec="${1:-${PDNS_HEALTHCHECK_TIMEOUT:-60}}"
	local pguser="$(cat /etc/powerdns/kube/*/webserver-port | tail -n1)"

	while [ "$sec" -gt 0 ]
	do
		echo "SELECT 1" | psql >/dev/null
		if [ $? -eq 0 ]
		then
			return 0
		fi
		sleep 5
		sec="$((sec - 5))"
	done
	echo "database did not respond" 1>&2
	return 1
}

if [ -z "$SOURCE_ONLY" ]
then
	pdnsHealthcheckPg $*
	return $?
fi
