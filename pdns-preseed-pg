#!/bin/sh

pdnsPreseedPg(){
	echo preseed-pg 1>&2
	seed="${1:-${PDNS_SEED_FILE:-/opt/docker-powerdns/psql.schema.sql}}"

	# check that db is up AND prepare psql
	! command -v pdnsHealthcheckPg && SOURCE_ONLY=1 source pdns-healthcheck-pg || true
	if ! pdnsHealthcheckPg
	then
		echo "pdnsPreseedPg failed" 1>&2
		return 1
	fi
	
	# TODO: create database?
	# for now assume postgres operator has created it

	echo "alter role $PGUSER set search_path = ${PGSCHEMA},\"\$user\",public" | psql --no-readline --echo-errors

	# TODO: test if we need to run or not
	# -1 -n -e
	psql --single-transaction --no-readline --echo-errors -f "$seed"
	return $?
}

if [ -z "$SOURCE_ONLY" ]
then
	echo pre preseed pg 1>&2
	pdnsPreseedPg $*
	return $?
fi
