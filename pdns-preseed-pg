#!/bin/sh

pdnsPreseedPg(){
	type -t pdnsScriptHelperInit && SOURCE_ONLY=1 source pdns-script-helpers && pdnsScriptHelperInit

	seed="${1:-${PDNS_SEED_FILE:-/opt/docker-powerdns/psql.schema.sql}}"
	
	pdns-healthcheck-pg 60
	
	# TODO: create database?
	# for now assume postgres operator has created it
	
	# TODO: get from env & set default schema for the role
	echo "alter role ${pdns_role} set search_path = "${pdns_schema},${pdns_role},public" | psql
	
	# TODO: test if we need to run or not
	
	cat "$seed" | pdns-psql 
}

[ -z "$SOURCE_ONLY" ] || exec pdnsPreseedPg $*
