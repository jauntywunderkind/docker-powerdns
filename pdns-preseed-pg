#!/bin/sh

pdnsPreseedPg(){
	seed="${1:-${PDNS_SEED_FILE:-/opt/docker-powerdns/psql.schema.sql}}"

	echo pg healthchecking 1>&2
	# check that db is up AND prepare psql
	source pdns-healthcheck-pg 60
	[ "$?" -ne 0 ] && return 1
	
	# TODO: create database?
	# for now assume postgres operator has created it

	echo pg search path 1>&2
	echo "alter role $PGUSER set search_path = \"${PGSCHEMA},public\"" | psql

	echo pg seed 1>&2	
	# TODO: test if we need to run or not
	psql -f "$seed"
}

[ -z "$SOURCE_ONLY" ] || exec pdnsPreseedPg $*
