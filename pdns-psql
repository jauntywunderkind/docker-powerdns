#!/bin/sh

pdnsPsqlKubeInit(){
	if ! command -v pdnsExportKubeEtc
	then
		SOURCE_ONLY=1 . pdns-script-helpers
	fi

	# this will export env vars
	pdnsExportKubeEtc ${1:-~/.pgenv.${PGROLE:-owner}}

	# we should know our user
	[ -z "$PGUSER" ] && echo "no PGUSER" 1>&2 && return 1 || true

	# make sure we have a pgpass
	local line="$PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASSWORD"
	if ! grep -n -q -e "^$line" ~/.pgpass 2>/dev/null
	then
		[ -z "$PGPASSWORD" ] && echo "no PGPASSWORD" 1>&2 && return 1 || true

		(echo "$line" && cat ~/.pgpass 2>/dev/null || true) > ~/.pgpass2
		mv ~/.pgpass2 ~/.pgpass
	fi
	chmod 0600 ~/.pgpass
	unset PGPASSWORD

	export PDNS_PSQL_KUBE_INIT_READY=1
}

if [ "${PDNS_PSQL_KUBE_INIT_READY:-0}" = 0 ]
	pdnsPsqlKubeInit
fi

if [ -z "$SOURCE_ONLY" ]
then
	psql $*
	return $?
fi
